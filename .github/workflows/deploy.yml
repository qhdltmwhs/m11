name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # íƒ€ìž„ì•„ì›ƒ ì„¤ì •

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨
            
            echo "ðŸ“¦ Starting deployment..."
            cd ~/pandamarket

            # .env íŒŒì¼ ìƒì„±/ë®ì–´ì“°ê¸°
            echo "ðŸ” Creating .env file..."
            cat > .env << 'EOF'
            ${{ secrets.ENV_FILE }}
            EOF

            # .env íŒŒì¼ ê²€ì¦
            if ! grep -q "DATABASE_URL" .env; then
              echo "âŒ Error: DATABASE_URL not found in .env"
              exit 1
            fi

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ðŸ”„ Pulling latest code..."
            git pull origin main

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "ðŸ›‘ Stopping containers..."
            docker-compose down

            # ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œìž‘
            echo "ðŸ—ï¸  Building and starting containers..."
            docker-compose up -d --build

            # ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸°
            echo "â³ Waiting for containers to be healthy..."
            sleep 10

            # DB ë§ˆì´ê·¸ë ˆì´ì…˜
            echo "ðŸ—„ï¸  Running database migrations..."
            docker-compose exec -T app npx prisma migrate deploy

            # ìƒíƒœ í™•ì¸
            echo "âœ… Deployment completed!"
            echo "ðŸ“Š Container status:"
            docker-compose ps

            # ë¡œê·¸ í™•ì¸ (ìµœê·¼ 10ì¤„)
            echo "ðŸ“‹ Recent logs:"
            docker-compose logs --tail=10 app

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment succeeded!"
          else
            echo "âŒ Deployment failed!"
          fi